name: RDP-Mac

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: macos-latest
    timeout-minutes: 3600

    steps:
      - name: Enable Screen Sharing (VNC) with password
        run: |
          # Activate Remote Management (Screen Sharing)
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
              -activate -configure -access -on -restart -agent -privs -all

          # Generate a random 12-character password
          VNC_PASS=$(openssl rand -base64 12)

          # Configure VNC password using kickstart (modern macOS supported)
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
              -configure -clientopts -setvnclegacy -vnclegacy yes \
              -clientopts -setvncpw -vncpw $VNC_PASS \
              -restart -agent

          echo "VNC_CREDS=User: $(whoami) | Password: $VNC_PASS" >> $GITHUB_ENV

      - name: Create Admin User (Optional)
        run: |
          USERNAME="RDP"
          PASSWORD=$(openssl rand -base64 12)
          sudo sysadminctl -addUser $USERNAME -password $PASSWORD -admin
          echo "RDP_CREDS=User: $USERNAME | Password: $PASSWORD" >> $GITHUB_ENV

      - name: Install Tailscale
        run: |
          curl -fsSL https://pkgs.tailscale.com/stable/Tailscale-1.90.9-macos.pkg -o /tmp/tailscale.pkg
          sudo installer -pkg /tmp/tailscale.pkg -target /
          rm /tmp/tailscale.pkg

      - name: Establish Tailscale Connection
        run: |
         sudo /Applications/Tailscale.app/Contents/MacOS/tailscale up \
          --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} \
          --hostname=gh-runner-$GITHUB_RUN_ID
         TS_IP=$(/Applications/Tailscale.app/Contents/MacOS/tailscale ip -4)
         echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV


      - name: Verify VNC Accessibility
        run: |
          echo "Tailscale IP: $TAILSCALE_IP"
          nc -zv $TAILSCALE_IP 5900 || { echo "VNC port not reachable"; exit 1; }
          echo "VNC connectivity successful!"

      - name: Maintain Connection
        run: |
          echo "=== VNC ACCESS ==="
          echo "Address: $TAILSCALE_IP"
          echo "Username: $USERNAME"
          echo "Password: $VNC_CREDS"
          echo "=================="
          while true; do
              echo "[$(date)] VNC Active - Use Ctrl+C to terminate workflow"
              sleep 300
          done
