name: RDP-Mac

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: macos-latest
    timeout-minutes: 3600

    steps:
      - name: Enable Screen Sharing (VNC)
        run: |
          # Enable Screen Sharing
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
              -activate -configure -access -on -restart -agent -privs -all

          # Allow VNC viewers with a password
          VNC_PASS=$(openssl rand -base64 12)
          sudo defaults write /Library/Preferences/com.apple.VNCSettings VNCPassword -data $(echo -n $VNC_PASS | perl -we 'print pack("H*", unpack("H*",<>))')
          echo "VNC_CREDS=User: $(whoami) | Password: $VNC_PASS" >> $GITHUB_ENV

      - name: Create Admin User (Optional)
        run: |
          USERNAME="RDP"
          PASSWORD=$(openssl rand -base64 12)
          sudo sysadminctl -addUser $USERNAME -password $PASSWORD -admin
          echo "RDP_CREDS=User: $USERNAME | Password: $PASSWORD" >> $GITHUB_ENV

      - name: Install Tailscale
        run: |
          curl -fsSL https://pkgs.tailscale.com/stable/tailscale_1.82.0_amd64.dmg -o /tmp/tailscale.dmg
          hdiutil attach /tmp/tailscale.dmg
          sudo installer -pkg /Volumes/Tailscale\ Installer/Tailscale.pkg -target /
          hdiutil detach /Volumes/Tailscale\ Installer
          rm /tmp/tailscale.dmg

      - name: Establish Tailscale Connection
        run: |
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-runner-$GITHUB_RUN_ID
          TS_IP=$(tailscale ip -4)
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV

      - name: Verify VNC Accessibility
        run: |
          echo "Tailscale IP: $TAILSCALE_IP"
          nc -zv $TAILSCALE_IP 5900 || { echo "VNC port not reachable"; exit 1; }
          echo "VNC connectivity successful!"

      - name: Maintain Connection
        run: |
          echo "=== VNC ACCESS ==="
          echo "Address: $TAILSCALE_IP"
          echo "Username: $USERNAME"
          echo "Password: $RDP_CREDS"
          echo "=================="
          while true; do
              echo "[$(date)] VNC Active - Use Ctrl+C to terminate workflow"
              sleep 300
          done
