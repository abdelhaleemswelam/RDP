name: RDP via Tailscale (Fixed Black Screen)

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: Install ALL required packages
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            xrdp \
            xorgxrdp \
            xfce4 \
            xfce4-goodies \
            xfce4-terminal \
            xvfb \
            xserver-xorg-video-dummy \
            dbus-x11 \
            dbus-user-session \
            policykit-1 \
            curl \
            gnupg \
            net-tools \
            openssl \
            sudo

      - name: Create RDP user
        run: |
          USERNAME="rdpuser"
          PASSWORD=$(openssl rand -base64 12)
          sudo useradd -m -s /bin/bash $USERNAME
          echo "$USERNAME:$PASSWORD" | sudo chpasswd
          sudo usermod -aG sudo $USERNAME
          sudo usermod -aG dialout $USERNAME
          echo "RDP_CREDS=User: $USERNAME | Password: $PASSWORD" >> $GITHUB_ENV
          echo "USERNAME=$USERNAME" >> $GITHUB_ENV

      - name: Configure X session properly
        run: |
          # Create proper .xsessionrc
          echo 'export XDG_SESSION_TYPE=x11' | sudo tee /home/$USERNAME/.xsessionrc
          echo 'export DISPLAY=:99' | sudo tee -a /home/$USERNAME/.xsessionrc
          echo 'export XDG_RUNTIME_DIR=/run/user/$(id -u)' | sudo tee -a /home/$USERNAME/.xsessionrc
          echo 'export DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/$(id -u)/bus' | sudo tee -a /home/$USERNAME/.xsessionrc
          sudo chown $USERNAME:$USERNAME /home/$USERNAME/.xsessionrc
          
          # Create .xsession with exec
          echo '#!/bin/bash' | sudo tee /home/$USERNAME/.xsession
          echo 'source ~/.xsessionrc' | sudo tee -a /home/$USERNAME/.xsession
          echo 'exec startxfce4' | sudo tee -a /home/$USERNAME/.xsession
          sudo chmod +x /home/$USERNAME/.xsession
          sudo chown $USERNAME:$USERNAME /home/$USERNAME/.xsession
          
          # Also create .xinitrc as fallback
          echo '#!/bin/bash' | sudo tee /home/$USERNAME/.xinitrc
          echo 'exec startxfce4' | sudo tee -a /home/$USERNAME/.xinitrc
          sudo chmod +x /home/$USERNAME/.xinitrc
          sudo chown $USERNAME:$USERNAME /home/$USERNAME/.xinitrc

      - name: Configure xrdp for Xvfb
        run: |
          # Backup original config
          sudo cp /etc/xrdp/xrdp.ini /etc/xrdp/xrdp.ini.backup
          
          # Configure xrdp to use Xvfb - REMOVE leading spaces from HEREDOC
          cat << 'EOF' | sudo tee /etc/xrdp/xrdp.ini > /dev/null
          [globals]
          bitmap_cache=yes
          bitmap_compression=yes
          port=3389
          crypt_level=low
          channel_code=1
          max_bpp=24

          [xrdp1]
          name=Xvfb
          lib=libxup.so
          username=ask
          password=ask
          ip=127.0.0.1
          port=-1
          EOF
          
          # Configure sesman to use Xvfb - REMOVE leading spaces from HEREDOC
          cat << 'EOF' | sudo tee /etc/xrdp/sesman.ini > /dev/null
          [Globals]
          ListenAddress=127.0.0.1
          ListenPort=3350
          EnableUserWindowManager=true
          UserWindowManager=startxfce4

          [Security]
          AllowRootLogin=true
          MaxLoginRetry=4
          TerminalServerUsers=tsusers
          TerminalServerAdmins=tsadmins
          AlwaysGroupCheck=false

          [Sessions]
          X11DisplayOffset=10
          MaxSessions=50
          KillDisconnected=false
          IdleTimeLimit=0
          DisconnectedTimeLimit=0

          [Logging]
          LogFile=/var/log/xrdp-sesman.log
          LogLevel=DEBUG
          EnableSyslog=true
          SyslogLevel=DEBUG
          EOF

      - name: Start Xvfb with proper configuration
        run: |
          # Create Xvfb startup script - REMOVE leading spaces from HEREDOC
          cat << 'EOF' | sudo tee /usr/local/bin/start-xvfb-session > /dev/null
          #!/bin/bash
          # Kill any existing Xvfb
          pkill Xvfb 2>/dev/null

          # Start Xvfb with proper configuration
          Xvfb :99 -screen 0 1280x720x24 -ac +extension RANDR +extension GLX +render -noreset &
          XVFB_PID=$!

          # Wait for Xvfb to start
          sleep 3

          # Set DISPLAY
          export DISPLAY=:99

          # Start DBus session
          eval $(dbus-launch --sh-syntax)

          # Start XFCE in background
          startxfce4 &

          # Keep script running
          wait $XVFB_PID
          EOF
          
          sudo chmod +x /usr/local/bin/start-xvfb-session

      - name: Start everything in correct order (FIXED)
        run: |
          # Kill any existing X servers and xrdp processes FIRST
          sudo pkill -9 Xvfb Xorg xrdp xrdp-sesman 2>/dev/null || true
          sleep 2
          
          # 1. Start Xvfb session
          /usr/local/bin/start-xvfb-session > /tmp/xvfb.log 2>&1 &
          sleep 8
          
          # 2. Start xrdp services WITHOUT systemctl (use direct commands)
          sudo xrdp-sesman --nodaemon > /tmp/xrdp-sesman.log 2>&1 &
          sleep 3
          sudo xrdp --nodaemon > /tmp/xrdp.log 2>&1 &
          sleep 3
          
          # 3. Verify everything is running
          echo "=== SYSTEM STATUS ==="
          echo "Xvfb processes:"
          ps aux | grep Xvfb | grep -v grep || echo "None found"
          echo ""
          echo "XFCE processes:"
          ps aux | grep xfce | grep -v grep || echo "None found"
          echo ""
          echo "xrdp processes:"
          ps aux | grep -E "(xrdp|xrdp-sesman)" | grep -v grep || echo "None found"
          echo ""
          echo "Listening ports:"
          sudo netstat -tulpn | grep -E '(:3389|:3350)' || echo "No ports found"

      - name: Install Tailscale
        run: |
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          echo "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu jammy main" | sudo tee /etc/apt/sources.list.d/tailscale.list
          sudo apt-get update
          sudo apt-get install -y tailscale

      - name: Start Tailscale
        run: |
          sudo tailscaled > /tmp/tailscaled.log 2>&1 &
          sleep 8
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-runner-$GITHUB_RUN_ID
          TS_IP=$(tailscale ip -4)
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV
          
          # Test RDP port
          echo "Testing RDP connectivity..."
          if timeout 10 bash -c 'until nc -z localhost 3389; do sleep 1; done'; then
            echo "✓ RDP port is listening"
          else
            echo "⚠️ RDP port not listening - checking logs"
            echo "xrdp log tail:"
            tail -10 /tmp/xrdp.log 2>/dev/null || echo "No xrdp log"
          fi

      - name: Display troubleshooting info
        run: |
          echo ""
          echo "========================================="
          echo "RDP CONNECTION INFORMATION"
          echo "========================================="
          echo "IP Address: $TAILSCALE_IP"
          echo "Port: 3389"
          echo "Username: $USERNAME"
          echo "Password: $(echo $RDP_CREDS | sed 's/.*Password: //')"
          echo ""
          echo "TROUBLESHOOTING:"
          echo "1. If black screen: Wait 30 seconds after connecting"
          echo "2. Try reconnecting 2-3 times"
          echo "3. Press Ctrl+Alt+Enter for fullscreen toggle"
          echo "========================================="
          
          # Show logs
          echo ""
          echo "Recent xrdp logs:"
          tail -20 /tmp/xrdp.log 2>/dev/null || echo "No xrdp.log found"
          echo ""
          echo "Recent sesman logs:"
          tail -20 /tmp/xrdp-sesman.log 2>/dev/null || echo "No sesman.log found"
          echo ""
          echo "Xvfb logs:"
          tail -10 /tmp/xvfb.log 2>/dev/null || echo "No xvfb.log found"

      - name: Keep alive with monitoring
        run: |
          echo "Monitoring system for 60 minutes..."
          echo "Press Ctrl+C in workflow to cancel"
          
          for i in $(seq 1 720); do
            if [ $((i % 12)) -eq 0 ]; then  # Every minute
              minute=$((i/12))
              echo ""
              echo "[$(date)] Minute $minute/60 - System Status:"
              
              # Check Xvfb
              if ps aux | grep -q Xvfb; then
                echo "  ✓ Xvfb running"
              else
                echo "  ⚠️ Xvfb NOT running - attempting restart"
                /usr/local/bin/start-xvfb-session > /tmp/xvfb-restart.log 2>&1 &
                sleep 2
              fi
              
              # Check xrdp processes
              if ps aux | grep -q xrdp && ps aux | grep -q xrdp-sesman; then
                echo "  ✓ xrdp processes running"
              else
                echo "  ⚠️ xrdp processes missing - restarting"
                sudo pkill -9 xrdp xrdp-sesman 2>/dev/null || true
                sudo xrdp-sesman --nodaemon > /tmp/xrdp-sesman-restart.log 2>&1 &
                sleep 2
                sudo xrdp --nodaemon > /tmp/xrdp-restart.log 2>&1 &
                sleep 2
              fi
              
              # Check port
              if netstat -tulpn | grep -q 3389; then
                echo "  ✓ Port 3389 listening"
              else
                echo "  ⚠️ Port 3389 NOT listening"
              fi
            fi
            
            sleep 5
          done
